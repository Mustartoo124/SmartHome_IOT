<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Home Control Screen</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style></style>
  </head>
  <body>
      
  <div class="switch-bar">
    <div class="switch-item active">Dashboard</div>
    <div class="switch-item">Chart</div>
    <div class="switch-item">Chatbot</div>
    <div id="username">guest</div>
    <span><svg fill="none" height="24" viewBox="0 0 24 24" width="24" ><path d="M17 16L21 12M21 12L17 8M21 12L7 12M13 16V17C13 18.6569 11.6569 20 10 20H6C4.34315 20 3 18.6569 3 17V7C3 5.34315 4.34315 4 6 4H10C11.6569 4 13 5.34315 13 7V8" stroke="#374151" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg></span>
  </div>
    <div class="dashboard-container" id="dashboard-container">
      <div class="control-panel">
        <div class="control-block first-block">
          <div class="header">
            <h1 class="time" id="time">--:--:--</h1>
            <p class="date" id="date">--/--/----</p>
          </div>
          <div class="sync">
          <button id="sync">Sync with Device</button>
        </div>
        </div>
        <div class="control-block second-block">
          <div class="temperature-humidity">
            <div class="icon-and-info">
              <div class="icon temperature-icon"></div>
              <div>
                <span class="room-info"><span id="temperature">26</span>°C</span>
              </div>
            </div>
            <div class="icon-and-info">
              <div class="icon humidity-icon"></div>
              <div>
                <span class="room-info"><span id="humidity">65</span>%</span>
              </div>
            </div>
          </div>
          <div class="gas-control">
            <div class="icon-and-info">
              <div class="gas-icon"></div>
              <div  class="title">
                <span class="gas-title">Gas</span>
                <span class="room-info"><span id="gasStatus">close</span></span>
              </div>
            </div>
            <div class="level-control">
              <div id="gas-level">0%</div>
              <div class="slider-container" id="gas-slider">
                <div class="slider-fill"></div>
              </div>
            </div>
          </div>
          <input type="range" id="gas-slider" min="0" max="100" value="0" style="display: none"/>
          <div class="light-control">
            <div class="icon-and-info">
              <div class="light-icon"></div>
              <div class="title">
                <span class="light-title">Light</span>
                <span class="room-info"><span id="lightStatus">on</span></span>
              </div>
            </div>
            <div id="state">&nbsp;&nbsp;&nbsp;</div>
            <button class="toggle-button" id="lightOff">OFF</button>
          </div>
        </div>
      </div>
      <div class="notifications-panel">
        <h2>Notifications<input type="date" id="date-picker" class="date-picker"/></h2>
        <div class="notifications-content">
          <ul id="notifications">
          </ul>
        </div>
      </div>
    </div>
    <div class="chart-container" id="chart-container">
      <div class="charts">
          <div class="chart-box">
              <canvas id="temperatureChart"></canvas>
          </div>
          <div class="chart-box">
              <canvas id="humidityChart"></canvas>
          </div>
      </div>
  </div>
  <div class="chatbot-container" id="chatbot-container">
    <div class="chatbot">
      <div class="chatbot-content">
        <ul id="chatbot-messages"></ul>
      </div>
      <div class="chatbot-input">
        <input type="text" id="chatbot-input" placeholder="Type a message..." />
        <button id="send-button">Send</button>
      </div>
    </div>
  </div>
  <script type="module">
    // Đọc giá trị username từ localStorage và cập nhật nội dung #username
const username = localStorage.getItem('username');
if (username) {
  document.getElementById('username').textContent = username;
}

// Thêm sự kiện onclick vào span để xóa localStorage và chuyển hướng đến trang login
document.querySelector('.switch-bar span').onclick = function() {
  localStorage.removeItem('username');
  window.location.href = './login.html';
};

    // Đặt giá trị mặc định là ngày hiện tại
const datePicker = document.getElementById('date-picker');
const today = new Date();
const formattedDate = today.toISOString().split('T')[0]; // Chuyển đổi thành định dạng yyyy-mm-dd
datePicker.value = formattedDate;

// Hàm gửi yêu cầu POST đến server để lấy dữ liệu thông báo
async function fetchNotifications(date) {

  try {
    const response = await fetch('http://localhost:3000/notifications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ date })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    displayNotifications(data.notifications, data.timestamps);
  } catch (error) {
    console.error('Error fetching notifications:', error);
  }
}

// Hàm hiển thị thông báo lên UI
function displayNotifications(notifications, timestamps) {
  const notificationsList = document.getElementById('notifications');
  notificationsList.innerHTML = ''; // Xóa nội dung cũ trước khi thêm mới

  notifications.forEach((notification, index) => {
    const listItem = document.createElement('li');
    listItem.classList.add('notification-item');
    listItem.innerHTML = `
      ${notification}
      <span class="notification-time">${timestamps[index]}</span>
    `;
    notificationsList.appendChild(listItem);
  });
}

// Lắng nghe sự thay đổi của ngày trong input
datePicker.addEventListener('change', (event) => {
  const selectedDate = event.target.value;
  fetchNotifications(selectedDate);
});

// Gọi hàm để tải thông báo theo ngày hiện tại khi trang được tải lần đầu
fetchNotifications(formattedDate);
async function fetchData() {
    try {
        const response = await fetch('http://localhost:3000/sensor');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const { humidities, temperatures } = data;
        createCharts(humidities, temperatures);
    } catch (error) {
        console.error('Error fetching sensor data:', error);
    }
}

function createCharts(humidityData, temperatureData) {
    const labels = [];
    for (let i = 0; i < 48; i++) {
        const hours = Math.floor(i / 2);
        const minutes = (i % 2 === 0) ? '00' : '30';
        labels.push(`${hours.toString().padStart(2, '0')}:${minutes}`);
    }

    const tempCtx = document.getElementById('temperatureChart').getContext('2d');
    new Chart(tempCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Temperature (°C)',
                data: temperatureData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 40
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#ffffff' }
                }
            }
        }
    });

    const humidityCtx = document.getElementById('humidityChart').getContext('2d');
    new Chart(humidityCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Humidity (%)',
                data: humidityData,
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { color: '#ffffff' }
                }
            }
        }
    });
}
fetchData();

    document.addEventListener("DOMContentLoaded", () => {
      const updateTime = () => {
        const now = new Date();
        document.getElementById("time").textContent = now.toLocaleTimeString();
        document.getElementById("date").textContent = now.toLocaleDateString();
        };
      setInterval(updateTime, 1000);
      updateTime();
      });
    const switchItems = document.querySelectorAll('.switch-item');
    const containers = {
      'dashboard': document.getElementById('dashboard-container'),
      'chart': document.getElementById('chart-container'),
      'chatbot': document.getElementById('chatbot-container')
    };

    switchItems.forEach(item => {
      item.addEventListener('click', () => {
        switchItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        Object.values(containers).forEach(container => container.style.display = 'none');
        const targetContent = item.textContent.toLowerCase();
        const targetContainer = containers[targetContent];
        if (targetContainer) {
          targetContainer.style.display = 'flex'; 
        }
      });
    });
    const sendButton = document.getElementById('send-button');
    const inputField = document.getElementById('chatbot-input');
    const messagesList = document.getElementById('chatbot-messages');
    sendButton.addEventListener('click', () => {
      const userInput = inputField.value.trim();
      if (userInput) {
        const userMessage = document.createElement('li');
        userMessage.className = 'user-message';
        userMessage.textContent = userInput;
        messagesList.appendChild(userMessage);

        const botMessage = document.createElement('li');
        botMessage.className = 'bot-message';
        botMessage.textContent = "I'm a chatbot, how can I help you?";
        messagesList.appendChild(botMessage);

        inputField.value = '';

        const chatbotContent = document.querySelector('.chatbot-content');
        chatbotContent.scrollTop = chatbotContent.scrollHeight;
      }
    });
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAGxRZC-StIXj5O75N4wTU7Xr0kNLXUfY",
      authDomain: "iotfirebase-cbc07.firebaseapp.com",
      databaseURL: "https://iotfirebase-cbc07-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iotfirebase-cbc07",
      storageBucket: "iotfirebase-cbc07.firebasestorage.app",
      messagingSenderId: "955902559692",
      appId: "1:955902559692:web:1131917a463653c0828969",
      measurementId: "G-X2XNFH1K9H"
    };
    
    //Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const database = getDatabase(app);
    //DOM elements
    const light = document.getElementById("lightOff");
    const status = document.getElementById("lightStatus");
    const sliderContainer = document.getElementById("gas-slider");
    const gasLevel = document.getElementById("gas-level");
    const sliderFill = sliderContainer.querySelector(".slider-fill");
    const gasStatus = document.getElementById("gasStatus");
    const temperatureElement = document.getElementById("temperature");
    const humidityElement = document.getElementById("humidity");
    const syncButton = document.getElementById("sync");
    //References to Firebase
    const servoRef = ref(database, "/servo");
    const lightRef = ref(database, "/light");
    const tempRef = ref(database, "/temp");
    const humidRef = ref(database, "/humid");
    const timeRef = ref(database, "/time");
    // control light
    const syncLightState = () => {
      onValue(lightRef, (snapshot) => {
        const lightState = snapshot.val();
        if (lightState) {
          light.textContent = "ON";
          light.style.backgroundColor = "#43b581";
          status.textContent = "on";
        } else {
          light.textContent = "OFF";
          light.style.backgroundColor = "#7289da";
          status.textContent = "off";
        }
      });
    };

    const toggleLight = () => {
      const isOn = light.textContent === "ON";
      set(lightRef, !isOn)
        .then(() => console.log("Light state updated successfully"))
        .catch((error) => console.error("Error updating light state:", error));
    };
    light.addEventListener("click", toggleLight);
    syncLightState();
    // control gas 
    let isDragging = false;
    function updateSliderUI(percentage) {
      sliderFill.style.width = `${percentage}%`;
      gasLevel.textContent = `${Math.round(percentage)}%`;
      const opacityValue = percentage / 100;
      sliderFill.style.opacity = opacityValue;
      if (percentage === 0) gasStatus.textContent = "close";
      else gasStatus.textContent = "open";
    }

    onValue(servoRef, (snapshot) => {
      const percentage = snapshot.val();
      if (percentage !== null) {
        const displayPercentage = (percentage / 180) * 100;
        updateSliderUI(displayPercentage);
      }
    });

    function updateGas(event) {
      const rect = sliderContainer.getBoundingClientRect();
      const offsetX = event.clientX - rect.left;
      const sliderWidth = sliderContainer.clientWidth;
      let newPercentage = Math.min(100, Math.max(0, (offsetX / sliderWidth) * 100));
      const firebaseValue = Math.round(newPercentage * 180 / 100);
      // Update Firebase with the new value
      set(servoRef, Math.round(firebaseValue)).catch((error) => {
        console.error("Error updating Firebase:", error);
      });
    }
    sliderContainer.addEventListener("mousedown", (event) => {
      isDragging = true;
      updateGas(event);
    });
    document.addEventListener("mousemove", (event) => {
      if (isDragging) updateGas(event);
    });
    document.addEventListener("mouseup", () => {
      isDragging = false;
    });
    // control temperature and humidity
    function updateTemperatureHumidity(temp, humid) {
      if (temp !== null) {
        temperatureElement.textContent = temp;
      }
      if (humid !== null) {
        humidityElement.textContent = humid;
      }
    }

    onValue(tempRef, (snapshot) => {
      const temp = snapshot.val();
      updateTemperatureHumidity(temp, null);
    });

    onValue(humidRef, (snapshot) => {
      const humid = snapshot.val();
      updateTemperatureHumidity(null, humid);
    });
    // Function to sync the current time with Firebase
    function syncWithDevice() {
      const now = new Date();
      const currentDay = now.getDate();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentSecond = now.getSeconds();

      const dateTimeString = `${currentDay.toString().padStart(2, '0')}-${currentMonth.toString().padStart(2, '0')}-${currentYear} ${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}:${currentSecond.toString().padStart(2, '0')}`;

      set(timeRef, dateTimeString)
        .then(() => {
          console.log(`Date and time set to ${dateTimeString}`);
        })
        .catch((error) => {
          console.error("Error setting date and time:", error);
        });
    }
    syncButton.addEventListener("click", syncWithDevice);
    </script>
  </body>
</html>
